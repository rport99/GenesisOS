# Load partition table and file system modules
insmod part_gpt
insmod part_msdos
insmod fat
insmod iso9660
insmod ntfs
insmod ntfscomp
insmod exfat
insmod udf

# Graphics setup
if loadfont "${prefix}/fonts/unicode.pf2" ; then
    insmod all_video
    set gfxmode=auto
    terminal_input console
    terminal_output gfxterm
fi

# Serial console
insmod serial
insmod usbserial_common
insmod usbserial_ftdi
insmod usbserial_pl2303
insmod usbserial_usbdebug
if serial --unit=0 --speed=115200; then
    terminal_input --append serial
    terminal_output --append serial
fi

# Platform identifier
if [ "${grub_platform}" = "efi" ]; then
    archiso_platform="UEFI"
elif [ "${grub_platform}" = "pc" ]; then
    archiso_platform="BIOS"
else
    archiso_platform="${grub_cpu}-${grub_platform}"
fi

# ==============================
# StormOS GRUB Theme (ISO boot)
# ==============================
set theme="/usr/share/grub/themes/stormos/theme.txt"
export theme
loadfont "/usr/share/grub/themesstormos/fonts/unicode.pf2"
background_image "/usr/share/grub/themes/stormos/background.png"

# ==============================
# Kernel parameters
# ==============================
set kernel_params="archisobasedir=stormos archisodevice=UUID=${ARCHISO_UUID} cow_spacesize=10G quiet splash loglevel=3 rd.udev.log_priority=3 vt.global_cursor_default=0"

# ==============================
# GRUB behaviour
# ==============================
set default=0
set timeout=5
set timeout_style=menu

# ==============================
# StormOS Live – Linux ZEN
# ==============================
menuentry "StormOS Live (Zen Kernel) [Default]" --class stormos --class zen {
    set gfxpayload=keep
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux-zen archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% cow_spacesize=10G copytoram=n
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux-zen.img
}

menuentry "StormOS Live (Zen Kernel, NVIDIA)" --class stormos --class nvidia {
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux-zen archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% cow_spacesize=10G copytoram=n nvidia-drm.modeset=1 nouveau.modeset=0
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux-zen.img
}

menuentry "StormOS Live (Zen Kernel, Safe Graphics)" --class stormos --class safe {
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux-zen archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% cow_spacesize=10G copytoram=nnomodeset
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux-zen.img
}

# ==============================
# StormOS Live – Linux LTS
# ==============================
menuentry "StormOS Live (LTS Kernel)" --class stormos --class lts {
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux-lts archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% cow_spacesize=10G copytoram=n
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux-lts.img
}

menuentry "StormOS Live (LTS Kernel, NVIDIA)" --class stormos --class nvidia {
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux-lts archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% cow_spacesize=10G copytoram=n nvidia-drm.modeset=1 nouveau.modeset=0
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux-lts.img
}

menuentry "StormOS Live (LTS Kernel, Safe Graphics)" --class stormos --class safe {
    linux /%INSTALL_DIR%/boot/%ARCH%/vmlinuz-linux-lts archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% cow_spacesize=10G copytoram=n} nomodeset
    initrd /%INSTALL_DIR%/boot/%ARCH%/initramfs-linux-lts.img
}

# ==============================
# Tools
# ==============================
if [ "${grub_platform}" = "efi" ]; then
    menuentry "UEFI Firmware Settings" --id uefi-firmware {
        fwsetup
    }
fi

menuentry "System shutdown" --class shutdown {
    halt
}

menuentry "System restart" --class reboot {
    reboot
}

# Accessibility beep
play 600 988 1 1319 4
